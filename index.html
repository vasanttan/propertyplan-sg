<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyPlan SG - Singapore Property Purchase Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .brand {
            font-weight: 700;
            color: white;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 100%;
        }

        @media (min-width: 600px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (min-width: 1200px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (min-width: 1600px) {
            .summary-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 8px; /* Reduced space between items */
        }

        .summary-item label {
            display: block;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .payment-schedule {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .payment-schedule table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-schedule th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .payment-schedule td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .payment-schedule tr:hover {
            background: #f8f9fa;
        }

        .info-badge {
            display: inline-block;
            background: #ffeaa7;
            color: #333;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s;
            border-radius: 15px 0 0 15px;
        }

        /* Multi-colored Progress Bar */
        .progress-bar-multi {
            width: 100%;
            height: 35px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            display: flex;
            position: relative;
        }

        .progress-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 0.5s;
            position: relative;
        }

        .progress-segment .progress-label {
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .progress-cpf {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .progress-sources {
            background: #34c759;
        }

        /* Funding Sources Panel */
        .funding-source-item {
            margin-bottom: 15px;
        }

        .funding-source-item label {
            font-weight: 500;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .funding-source-item input {
            font-size: 0.95em;
        }

        .funding-source-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .funding-source-row input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .funding-source-row input[type="text"]:first-child {
            flex: 1;
        }

        .funding-source-row input[type="text"]:last-of-type {
            flex: 1;
        }

        .funding-source-row button {
            padding: 8px 12px;
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .funding-source-row button:hover {
            background: #c9302c;
        }
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 15px;
        }

        .display-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .display-selector label {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
        }

        .display-selector select {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .display-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-export {
            background: #34c759;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(52, 199, 89, 0.2);
        }

        .btn-export:hover {
            background: #2fb350;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 199, 89, 0.3);
        }

        /* Save & Compare Styles */
        .save-compare-section {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-save, .btn-compare {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-save:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .btn-compare {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-compare:hover {
            background: #f0f2ff;
        }

        .btn-compare:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .saved-scenarios {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px dashed #667eea;
        }

        .saved-scenarios h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scenario-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }

        .scenario-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateX(3px);
        }

        .scenario-info {
            flex: 1;
        }

        .scenario-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .scenario-details {
            font-size: 0.85em;
            color: #666;
        }

        .scenario-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #f0f0f0;
        }

        .btn-load {
            color: #667eea;
        }

        .btn-delete {
            color: #dc3545;
        }

        .btn-select {
            color: #28a745;
        }

        /* Comparison Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        /* View Toggle Button */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 40px;
            padding: 20px;
            background: #f5f5f7;
            border-radius: 12px;
        }

        .scenario-select-card {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }

        .scenario-select-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .scenario-select-card input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .scenario-select-card span {
            cursor: pointer;
        }

        .scenario-select-card.selected {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        @media (min-width: 768px) {
            .comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .comparison-grid.three-col {
                grid-template-columns: repeat(3, 1fr);
            }
            .comparison-grid.four-col {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .comparison-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #d2d2d7;
            transition: all 0.3s;
            position: relative;
        }

        .comparison-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }

        .comparison-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }

        .comparison-card-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .comparison-card-subtitle {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .comparison-card-price {
            font-size: 2em;
            font-weight: 700;
            margin: 15px 0 5px 0;
        }

        .comparison-card-body {
            padding: 30px 20px;
        }

        .comparison-section {
            margin-bottom: 30px;
        }

        .comparison-section:last-child {
            margin-bottom: 0;
        }

        .comparison-section-title {
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            color: #86868b;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .comparison-feature {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f7;
        }

        .comparison-feature:last-child {
            border-bottom: none;
        }

        .comparison-feature-label {
            font-size: 0.95em;
            color: #1d1d1f;
            font-weight: 500;
        }

        .comparison-feature-value {
            font-size: 0.95em;
            color: #1d1d1f;
            font-weight: 600;
            text-align: right;
        }

        .comparison-feature-value.best {
            color: #34c759;
            position: relative;
        }

        .comparison-feature-value.best::before {
            content: "üèÜ";
            display: inline-block;
            margin-right: 4px;
            font-weight: bold;
        }

        .comparison-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #34c759;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .comparison-monthly-payment {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .comparison-monthly-label {
            font-size: 0.85em;
            color: #86868b;
            margin-bottom: 5px;
        }

        .comparison-monthly-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1d1d1f;
        }

        .no-scenarios-selected {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .no-scenarios-selected-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .no-scenarios-selected p {
            font-size: 1.1em;
        }

        .modal-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 0;
            border-bottom: none;
        }

        .modal-header h2 {
            display: none; /* Using inline header now */
        }

        /* View Toggle Button */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: #f5f5f7;
            padding: 4px;
            border-radius: 8px;
            margin-right: 10px;
        }

        .comparison-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 40px;
            padding: 20px;
            background: #f5f5f7;
            border-radius: 12px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: #333;
        }

        .view-toggle-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close:hover {
            background: #f0f0f0;
            color: #000;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .comparison-table .row-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .highlight-best {
            background: #d4edda !important;
            font-weight: 600;
        }

        .scenario-checkbox {
            margin-right: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Custom Input Modal */
        .input-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .input-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .input-modal-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .input-modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .input-modal-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .input-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .input-modal-btn.primary:hover {
            background: #5568d3;
        }

        .input-modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .input-modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        /* Alert Modal */
        .alert-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .alert-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }

        .alert-modal-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .alert-modal-message {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        .alert-modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: #667eea;
            color: white;
            transition: all 0.2s;
        }

        .alert-modal-btn:hover {
            background: #5568d3;
        }

        /* Confirm Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .confirm-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }

        .confirm-modal-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .confirm-modal-message {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-modal-btn.danger {
            background: #dc3545;
            color: white;
        }

        .confirm-modal-btn.danger:hover {
            background: #c82333;
        }

        .confirm-modal-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }

        .confirm-modal-btn.cancel:hover {
            background: #d0d0d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† <span class="brand">PropertyPlan SG</span></h1>
            <p id="subtitle">Plan and track your S$1.3M property investment</p>
        </div>

        <div class="dashboard">
            <!-- Input Card -->
            <div class="card">
                <h2>User Profile</h2>
                
                <div class="input-group">
                    <label>Your Current Age</label>
                    <input type="number" id="age" value="35" min="21" max="64" step="1" oninput="updateMaxTenure()">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        üìÖ Used to calculate maximum loan tenure
                    </small>
                </div>

                <div class="input-group">
                    <label>Monthly Household Income (SGD)</label>
                    <input type="text" id="monthlyIncome" value="15,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>CPF Available for Down Payment (SGD)</label>
                    <input type="text" id="cpfAvailable" value="100,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>Monthly CPF Contribution for Mortgage (SGD)</label>
                    <input type="text" id="monthlyCPF" value="2,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>Buyer Profile</label>
                    <select id="buyerProfile" onchange="updateABSD()">
                        <option value="sc_first">Singapore Citizen - 1st Property</option>
                        <option value="sc_second">Singapore Citizen - 2nd Property</option>
                        <option value="sc_third">Singapore Citizen - 3rd+ Property</option>
                        <option value="pr_first">PR - 1st Property</option>
                        <option value="pr_second">PR - 2nd+ Property</option>
                        <option value="foreigner">Foreigner</option>
                        <option value="entity">Entity (Company/Trust)</option>
                    </select>
                </div>

                <div class="input-group" id="entityTypeGroup" style="display: none;">
                    <label>Entity Type</label>
                    <select id="entityType" onchange="updateABSD()">
                        <option value="housing_developer">Housing Developer</option>
                        <option value="other_entity">Other Entity</option>
                    </select>
                </div>

                <div class="info-badge" id="absdInfo" style="background: #d4edda;">
                    üèõÔ∏è ABSD: 0% (No additional stamp duty)
                </div>
            </div>

            <!-- Purchase Details Card -->
            <div class="card">
                <h2>Purchase Details</h2>
                
                <div class="input-group">
                    <label>Property Type</label>
                    <select id="propertyType" onchange="updatePropertyType()">
                        <option value="condo">Private Condo (Resale)</option>
                        <option value="hdb">HDB Flat (Resale)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Property Price (SGD)</label>
                    <input type="text" id="propertyPrice" value="1,300,000" oninput="formatNumberInput(this); updateSubtitle(); validateDownPayment()">
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Down Payment (%)</label>
                        <input type="number" id="downPaymentPercent" value="25" min="25" max="100" oninput="validateDownPayment()">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="downPaymentRemark">
                            üí∞ Min: 25% for resale condo (5% cash + 20% cash/CPF)
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Loan Tenure (Years)</label>
                        <input type="number" id="loanTenure" value="25" min="1" max="30" step="1" oninput="validateTenure()" onblur="validateTenure()">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="tenureRemark">
                            ‚è±Ô∏è Max: 30 years or up to age 65 (whichever is shorter)
                        </small>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" id="interestRate" value="2.6" step="0.1" min="0">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="interestRateRemark">
                            üìä Current market rate for bank loans
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Loan Type</label>
                        <select id="loanType" onchange="updateLoanType()">
                            <option value="bank_fixed">Bank Loan - Fixed Rate</option>
                            <option value="bank_floating">Bank Loan - Floating Rate</option>
                            <option value="hdb" disabled>HDB Loan (HDB properties only)</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="calculate()">Calculate Payment Plan</button>

                <div class="save-compare-section">
                    <button class="btn-save" id="btnSaveScenario" onclick="saveScenario()">üíæ Save Scenario</button>
                    <button class="btn-compare" id="btnCompare" onclick="openCompareModal()" disabled>üìä Compare Scenarios</button>
                </div>

                <div class="info-badge" id="cashCpfInfo">
                    üí° 5% must be paid in cash, remaining down payment can use CPF
                </div>
            </div>

            <!-- Summary Card -->
            <div class="card full-width">
                <h2>Financial Summary</h2>
                
                <div class="summary-grid">
                    
                    <div class="summary-item">
                        <label>üí∞ Down Payment</label>
                        <div class="value" id="downPaymentAmount">S$325,000</div>
                    </div>
                    <div class="summary-item">
                        <label>üè¶ Loan Amount</label>
                        <div class="value" id="loanAmount">S$975,000</div>
                    </div>
                    <div class="summary-item">
                        <label>üí≥ Monthly Payment</label>
                        <div class="value" id="monthlyPayment">S$4,350</div>
                    </div>
                    <div class="summary-item">
                        <label>üìä Total Interest</label>
                        <div class="value" id="totalInterest">S$330,000</div>
                    </div>
                    
                    <div class="summary-item">
                        <label>üìú Buyer's Stamp Duty (BSD)</label>
                        <div class="value" id="stampDuty">S$43,600</div>
                    </div>
                    <div class="summary-item">
                        <label>üìã Additional BSD (ABSD)</label>
                        <div class="value" id="absdAmount">S$0</div>
                    </div>
                    <div class="summary-item">
                        <label>üìë Total Stamp Duty</label>
                        <div class="value" id="totalStampDuty">S$43,600</div>
                    </div>
                    
                    <div class="summary-item">
                        <label>üíµ Total Cash Needed</label>
                        <div class="value" id="cashNeeded">S$268,600</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 3px;">Cash Down + BSD + ABSD</div>
                    </div>
                    <div class="summary-item">
                        <label>üí∏ Remaining Cash Needed</label>
                        <div class="value" id="remainingCashNeeded" style="color: #d9534f; font-weight: bold;">S$148,600</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 3px;">After CPF & Savings</div>
                    </div>
                    <div class="summary-item">
                        <label>üè¢ Total Amount Needed</label>
                        <div class="value" id="totalAmountNeeded">S$1,268,600</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 3px;">Property + Duties</div>
                    </div>
                    
                    <div class="summary-item">
                        <label>üìà TDSR Ratio</label>
                        <div class="value" id="tdsrRatio">29%</div>
                        <div id="tdsrWarning" style="font-size: 0.85em; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="summary-item">
                        <label>üí¥ Cash After CPF</label>
                        <div class="value" id="cashPayment">S$0</div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>Upfront Payment Progress</label>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">
                        Track funding for down payment + stamp duties (BSD + ABSD)
                    </div>
                    <div class="progress-bar-multi" id="progressBarMulti">
                        <div class="progress-segment progress-cpf" id="progressCPF" style="width: 30%;">
                            <span class="progress-label">CPF: 30%</span>
                        </div>
                        <div class="progress-segment progress-sources" id="progressSources" style="width: 0%;">
                            <span class="progress-label"></span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <div id="progressSummary">Total: 30%</div>
                    </div>
                    
                    <!-- Expandable Funding Sources -->
                    <div style="margin-top: 15px;">
                        <button type="button" onclick="toggleFundingSources()" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; padding: 5px;">
                            <span id="fundingToggleIcon">‚ñ∂</span> Add Funding Sources
                        </button>
                        
                        <div id="fundingSourcesPanel" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
                            <h4 style="margin: 0 0 15px 0; font-size: 1em; color: #667eea;">üí∞ Additional Funding Sources</h4>
                            
                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px; font-size: 0.85em; color: #666;">
                                üí° Add other sources like cash savings, investments, gifts, bonuses, etc.
                            </div>
                            
                            <!-- Funding Sources Container -->
                            <div id="fundingSourcesContainer"></div>
                            
                            <button type="button" onclick="addFundingSource()" style="margin-top: 10px; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                + Add Funding Source
                            </button>
                            
                            <!-- Templates -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Quick Templates:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                    <button type="button" onclick="addFundingSourceTemplate('Cash Savings')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üíµ Cash Savings</button>
                                    <button type="button" onclick="addFundingSourceTemplate('Stock Investment')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üìà Stock Investment</button>
                                    <button type="button" onclick="addFundingSourceTemplate('Crypto Investment')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">‚Çø Crypto</button>
                                    <button type="button" onclick="addFundingSourceTemplate('Parents Gift')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üéÅ Parents Gift</button>
                                    <button type="button" onclick="addFundingSourceTemplate('Bonus')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üí∞ Bonus</button>
                                    <button type="button" onclick="addFundingSourceTemplate('Fixed Deposit')" style="padding: 4px 8px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üè¶ Fixed Deposit</button>
                                </div>
                            </div>
                            
                            <!-- Legend -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div style="font-size: 0.85em; color: #666;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <span style="width: 12px; height: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 2px;"></span>
                                        <span>CPF Ordinary Account</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="width: 12px; height: 12px; background: #34c759; border-radius: 2px;"></span>
                                        <span>Other Funding Sources</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-badge">
                    üìä TDSR limit: 55% of gross monthly income
                </div>

                <div class="saved-scenarios" id="savedScenariosPanel">
                    <h3>üìÅ Saved Scenarios</h3>
                    <div id="savedScenariosList">
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-state-icon">üíæ</div>
                            <p style="color: #999; font-size: 0.9em;">No saved scenarios yet. Click "Save Scenario" to start comparing properties!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Breakdown Chart -->
            <div class="card full-width">
                <h2>Payment Breakdown Over Time</h2>
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>

            <!-- Payment Schedule -->
            <div class="card full-width">
                <h2>Monthly Payment Schedule</h2>
                <div class="payment-schedule">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Payment</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                        </tbody>
                    </table>
                </div>
                <div class="schedule-controls">
                    <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                    <div class="display-selector">
                        <label>Show:</label>
                        <select id="scheduleDisplay" onchange="calculate()">
                            <option value="12">12 months</option>
                            <option value="60">5 years</option>
                            <option value="120">10 years</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Compare Property Scenarios</h2>
                <button class="close" onclick="closeCompareModal()">&times;</button>
            </div>
            <div id="comparisonContent"></div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="inputModal" class="input-modal">
        <div class="input-modal-content">
            <div class="input-modal-header">üíæ Save Scenario</div>
            <input type="text" id="scenarioNameInput" class="input-modal-input" placeholder="Enter scenario name...">
            <div class="input-modal-buttons">
                <button class="input-modal-btn secondary" onclick="closeInputModal()">Cancel</button>
                <button class="input-modal-btn primary" onclick="confirmSaveScenario()">Save</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-modal-content">
            <div class="alert-modal-icon" id="alertIcon">‚úÖ</div>
            <div class="alert-modal-message" id="alertMessage"></div>
            <button class="alert-modal-btn" onclick="closeAlertModal()">OK</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-icon">‚ö†Ô∏è</div>
            <div class="confirm-modal-message" id="confirmMessage"></div>
            <div class="confirm-modal-buttons">
                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-modal-btn danger" onclick="confirmAction()">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let paymentChart;

        function formatCurrency(amount) {
            return 'S$' + amount.toLocaleString('en-SG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return 'S$' + (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return 'S$' + (amount / 1000).toFixed(0) + 'K';
            }
            return 'S$' + amount.toLocaleString('en-SG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatNumberInput(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/[^\d]/g, '');
            
            // Convert to number and back to formatted string
            if (value) {
                let number = parseInt(value);
                input.value = number.toLocaleString('en-SG');
            }
        }

        function getNumericValue(input) {
            // Remove commas and convert to number
            return parseFloat(input.value.replace(/,/g, '')) || 0;
        }

        function updateSubtitle() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const subtitle = document.getElementById('subtitle');
            subtitle.textContent = `Plan and track your ${formatCurrencyShort(propertyPrice)} property investment`;
        }

        function calculateStampDuty(price) {
            let duty = 0;
            if (price <= 180000) {
                duty = price * 0.01;
            } else if (price <= 360000) {
                duty = 1800 + (price - 180000) * 0.02;
            } else if (price <= 1000000) {
                duty = 1800 + 3600 + (price - 360000) * 0.03;
            } else {
                duty = 1800 + 3600 + 19200 + (price - 1000000) * 0.04;
            }
            return duty;
        }

        function calculateABSD(price, buyerProfile, entityType = null, propertyType = 'condo') {
            // HDB properties: No ABSD for Singapore Citizens and PRs
            if (propertyType === 'hdb') {
                if (buyerProfile === 'sc_first' || buyerProfile === 'sc_second' || buyerProfile === 'sc_third' ||
                    buyerProfile === 'pr_first' || buyerProfile === 'pr_second') {
                    return 0; // No ABSD for citizens and PRs buying HDB
                }
            }
            
            const rates = {
                'sc_first': 0,
                'sc_second': 0.20,
                'sc_third': 0.30,
                'pr_first': 0.05,
                'pr_second': 0.30,
                'foreigner': 0.60,
                'entity': entityType === 'housing_developer' ? 0.35 : 0.65
            };
            
            const rate = rates[buyerProfile] || 0;
            return price * rate;
        }

        function getABSDRate(buyerProfile, entityType = null, propertyType = 'condo') {
            // HDB properties: No ABSD for Singapore Citizens and PRs
            if (propertyType === 'hdb') {
                if (buyerProfile === 'sc_first' || buyerProfile === 'sc_second' || buyerProfile === 'sc_third' ||
                    buyerProfile === 'pr_first' || buyerProfile === 'pr_second') {
                    return 0;
                }
            }
            
            const rates = {
                'sc_first': 0,
                'sc_second': 20,
                'sc_third': 30,
                'pr_first': 5,
                'pr_second': 30,
                'foreigner': 60,
                'entity': entityType === 'housing_developer' ? 35 : 65
            };
            
            return rates[buyerProfile] || 0;
        }

        function updateABSD() {
            const buyerProfile = document.getElementById('buyerProfile').value;
            const entityTypeGroup = document.getElementById('entityTypeGroup');
            const absdInfo = document.getElementById('absdInfo');
            const propertyType = document.getElementById('propertyType').value;
            
            // Show/hide entity type selection
            if (buyerProfile === 'entity') {
                entityTypeGroup.style.display = 'block';
            } else {
                entityTypeGroup.style.display = 'none';
            }
            
            // Update ABSD info badge
            const entityType = document.getElementById('entityType').value;
            const rate = getABSDRate(buyerProfile, entityType, propertyType);
            
            if (rate === 0) {
                absdInfo.style.background = '#d4edda';
                if (propertyType === 'hdb' && (buyerProfile.startsWith('sc_') || buyerProfile.startsWith('pr_'))) {
                    absdInfo.innerHTML = 'üèõÔ∏è ABSD: 0% (No ABSD for citizens/PRs buying HDB)';
                } else {
                    absdInfo.innerHTML = 'üèõÔ∏è ABSD: 0% (No additional stamp duty)';
                }
            } else {
                absdInfo.style.background = '#ffd7d7';
                absdInfo.innerHTML = `üèõÔ∏è ABSD: ${rate}% applies to your purchase`;
            }
            
            // Recalculate if needed
            calculate();
        }

        function updateMaxTenure() {
            const ageInput = document.getElementById('age');
            let age = parseFloat(ageInput.value) || 35;
            
            // Round age to integer if decimal
            if (!Number.isInteger(age)) {
                age = Math.round(age);
                ageInput.value = age;
            }
            
            const maxAge = 65;
            const maxTenureByAge = Math.max(1, maxAge - age);
            const absoluteMaxTenure = 30;
            const maxTenure = Math.min(maxTenureByAge, absoluteMaxTenure);
            
            const tenureInput = document.getElementById('loanTenure');
            const tenureRemark = document.getElementById('tenureRemark');
            const currentValue = parseInt(tenureInput.value);
            
            // Update max attribute
            tenureInput.max = maxTenure;
            
            // Update the current value if it exceeds the max
            if (currentValue > maxTenure) {
                tenureInput.value = maxTenure;
                tenureInput.style.borderColor = '#d9534f';
            } else {
                tenureInput.style.borderColor = '#e0e0e0';
            }
            
            // Update remark
            // Show red when age is the limiting factor (age-based max < standard 30)
            if (maxTenureByAge < absoluteMaxTenure) {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (based on age ${age}, loan must end by 65)`;
                tenureRemark.style.color = '#d9534f';
            } else {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (standard maximum)`;
                tenureRemark.style.color = '#666';
            }
        }

        function validateTenure() {
            const age = parseInt(document.getElementById('age').value) || 35;
            const tenureInput = document.getElementById('loanTenure');
            const tenureRemark = document.getElementById('tenureRemark');
            const maxAge = 65;
            const maxTenureByAge = Math.max(1, maxAge - age);
            const absoluteMaxTenure = 30;
            const maxTenure = Math.min(maxTenureByAge, absoluteMaxTenure);
            let currentValue = parseFloat(tenureInput.value);
            
            // Round to nearest integer if decimal (handles 30.5 ‚Üí 31, then validates to 30)
            if (!Number.isInteger(currentValue)) {
                currentValue = Math.round(currentValue);
                tenureInput.value = currentValue;
            }
            
            // Update max attribute to ensure it's current
            tenureInput.max = maxTenure;
            
            // Validate and correct value if needed
            if (currentValue > maxTenure) {
                tenureInput.value = maxTenure;
                tenureInput.style.borderColor = '#d9534f';
            } else if (currentValue < 1) {
                tenureInput.value = 1;
                tenureInput.style.borderColor = '#d9534f';
            } else if (isNaN(currentValue)) {
                tenureInput.value = maxTenure;
                tenureInput.style.borderColor = '#d9534f';
            } else {
                tenureInput.style.borderColor = '#e0e0e0';
            }
            
            // Update remark with current information
            // Show red when age is the limiting factor (age-based max < standard 30)
            if (maxTenureByAge < absoluteMaxTenure) {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (based on age ${age}, loan must end by 65)`;
                tenureRemark.style.color = '#d9534f';
            } else {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (standard maximum)`;
                tenureRemark.style.color = '#666';
            }
        }

        function validateDownPayment() {
            const downPaymentInput = document.getElementById('downPaymentPercent');
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentRemark = document.getElementById('downPaymentRemark');
            const downPaymentPercent = parseFloat(downPaymentInput.value);
            const propertyType = document.getElementById('propertyType').value;
            
            // Determine minimum down payment based on property type and loan amount
            const loanAmount = propertyPrice * (1 - downPaymentPercent / 100);
            let minDownPayment = 25; // Default 25% for resale condo
            
            if (propertyType === 'hdb') {
                // HDB rules
                minDownPayment = 20; // HDB minimum is 20%
            } else {
                // Condo rules
                // For bank loans on private property:
                // - First $1M: max 75% LTV (25% down payment)
                // - Above $1M: max 45% LTV (55% down payment) for the excess
                
                if (loanAmount > 1000000) {
                    // Calculate required down payment for loans above $1M
                    const excessAmount = propertyPrice - 1000000;
                    const minDownPaymentAmount = (propertyPrice * 0.25) + (excessAmount * 0.30);
                    minDownPayment = Math.ceil((minDownPaymentAmount / propertyPrice) * 100);
                }
            }
            
            // Update min attribute
            downPaymentInput.min = minDownPayment;
            
            // Show warnings but allow user to edit
            if (downPaymentPercent < minDownPayment) {
                downPaymentRemark.innerHTML = `‚ö†Ô∏è Warning: Minimum ${minDownPayment}% required to meet LTV limits`;
                downPaymentRemark.style.color = '#d9534f';
                downPaymentInput.style.borderColor = '#d9534f';
            } else if (downPaymentPercent > 100) {
                downPaymentRemark.innerHTML = `‚ö†Ô∏è Warning: Cannot exceed 100% (full cash purchase)`;
                downPaymentRemark.style.color = '#d9534f';
                downPaymentInput.style.borderColor = '#d9534f';
            } else {
                // Show appropriate message based on property type
                if (propertyType === 'hdb') {
                    downPaymentRemark.innerHTML = `üí∞ Min: 20% for HDB resale (max 80% LTV)`;
                } else if (propertyPrice > 1000000) {
                    downPaymentRemark.innerHTML = `üí∞ Min: ${minDownPayment}% for properties above S$1M (LTV restrictions apply)`;
                } else {
                    downPaymentRemark.innerHTML = `üí∞ Min: 25% for resale condo (max 75% LTV)`;
                }
                downPaymentRemark.style.color = '#666';
                downPaymentInput.style.borderColor = '#e0e0e0';
            }
        }

        function updatePropertyType() {
            const propertyType = document.getElementById('propertyType').value;
            const loanTypeSelect = document.getElementById('loanType');
            const buyerProfileSelect = document.getElementById('buyerProfile');
            const interestRateInput = document.getElementById('interestRate');
            const interestRateRemark = document.getElementById('interestRateRemark');
            const propertyPriceInput = document.getElementById('propertyPrice');
            
            if (propertyType === 'hdb') {
                // Enable HDB loan option
                loanTypeSelect.querySelector('option[value="hdb"]').disabled = false;
                loanTypeSelect.value = 'hdb';
                
                // Set HDB loan rate
                interestRateInput.value = '2.6';
                interestRateRemark.innerHTML = 'üè¶ HDB loan rate: CPF OA rate + 0.1%';
                interestRateRemark.style.color = '#5cb85c';
                
                // Update default price for HDB
                if (getNumericValue(propertyPriceInput) > 1000000) {
                    propertyPriceInput.value = '500,000';
                    formatNumberInput(propertyPriceInput);
                }
                
                // Disable entity options for HDB
                buyerProfileSelect.querySelector('option[value="entity"]').disabled = true;
                if (buyerProfileSelect.value === 'entity') {
                    buyerProfileSelect.value = 'sc_first';
                }
                
            } else {
                // Disable HDB loan option for condo
                loanTypeSelect.querySelector('option[value="hdb"]').disabled = true;
                if (loanTypeSelect.value === 'hdb') {
                    loanTypeSelect.value = 'bank_floating';
                }
                
                interestRateInput.value = '2.6';
                interestRateRemark.innerHTML = 'üìä Current market rate for bank loans';
                interestRateRemark.style.color = '#666';
                
                // Update default price for condo
                if (getNumericValue(propertyPriceInput) < 800000) {
                    propertyPriceInput.value = '1,300,000';
                    formatNumberInput(propertyPriceInput);
                }
                
                // Enable entity options for condo
                buyerProfileSelect.querySelector('option[value="entity"]').disabled = false;
            }
            
            updateLoanType();
            validateDownPayment();
            updateMaxTenure(); // Update tenure validation when property type changes
            updateSubtitle();
            updateABSD();
        }

        function updateLoanType() {
            const loanType = document.getElementById('loanType').value;
            const interestRateInput = document.getElementById('interestRate');
            const interestRateRemark = document.getElementById('interestRateRemark');
            
            if (loanType === 'hdb') {
                // HDB loan rate (CPF OA + 0.1%)
                interestRateInput.value = '2.6';
                interestRateInput.disabled = true;
                interestRateRemark.innerHTML = 'üè¶ HDB loan rate: CPF OA rate (2.5%) + 0.1% = 2.6%';
                interestRateRemark.style.color = '#5cb85c';
            } else {
                interestRateInput.disabled = false;
                if (loanType === 'bank_fixed') {
                    interestRateInput.value = '2.6';
                    interestRateRemark.innerHTML = 'üìä Typical fixed rate: 2.4% - 2.8%';
                } else {
                    interestRateInput.value = '2.6';
                    interestRateRemark.innerHTML = 'üìä Typical floating rate (SORA): 2.5% - 3.0%';
                }
                interestRateRemark.style.color = '#666';
            }
        }

        function calculate() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value);
            const loanTenure = parseFloat(document.getElementById('loanTenure').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const monthlyIncome = getNumericValue(document.getElementById('monthlyIncome'));
            const cpfAvailable = getNumericValue(document.getElementById('cpfAvailable'));
            const monthlyCPF = getNumericValue(document.getElementById('monthlyCPF'));
            const buyerProfile = document.getElementById('buyerProfile').value;
            const entityType = document.getElementById('entityType').value;
            const propertyType = document.getElementById('propertyType').value;

            // Update subtitle
            updateSubtitle();

            // Calculate basic values
            const downPayment = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPayment;
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTenure * 12;

            // Calculate monthly payment using mortgage formula
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / 
                                   (Math.pow(1 + monthlyRate, totalPayments) - 1);

            const totalPaid = monthlyPayment * totalPayments;
            const totalInterest = totalPaid - loanAmount;

            // Calculate stamp duties
            const stampDuty = calculateStampDuty(propertyPrice);
            const absdAmount = calculateABSD(propertyPrice, buyerProfile, entityType, propertyType);
            const totalStampDuty = stampDuty + absdAmount;

            // Calculate upfront costs
            const minCashDownPayment = propertyPrice * 0.05; // 5% must be cash
            const cpfUsedForDownPayment = Math.min(cpfAvailable, downPayment - minCashDownPayment);
            const cashForDownPayment = downPayment - cpfUsedForDownPayment;
            const totalCashNeeded = cashForDownPayment + totalStampDuty; // ABSD + BSD must be paid in cash
            const totalAmountNeeded = propertyPrice + totalStampDuty; // Total including property price and all duties

            // Calculate TDSR
            const tdsrRatio = (monthlyPayment / monthlyIncome) * 100;

            // Update cash/CPF info based on property type
            const cashCpfInfo = document.getElementById('cashCpfInfo');
            if (propertyType === 'hdb') {
                cashCpfInfo.innerHTML = 'üí° HDB: Min 5% cash down payment, can use CPF for remaining';
            } else {
                cashCpfInfo.innerHTML = 'üí° Condo: Min 5% cash, remaining down payment can use CPF';
            }

            // Update summary
            document.getElementById('downPaymentAmount').textContent = formatCurrency(downPayment);
            document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
            document.getElementById('stampDuty').textContent = formatCurrency(stampDuty);
            document.getElementById('absdAmount').textContent = formatCurrency(absdAmount);
            document.getElementById('totalStampDuty').textContent = formatCurrency(totalStampDuty);
            document.getElementById('cashNeeded').textContent = formatCurrency(totalCashNeeded);
            document.getElementById('totalAmountNeeded').textContent = formatCurrency(totalAmountNeeded);
            
            // Update TDSR with color coding
            const tdsrElement = document.getElementById('tdsrRatio');
            const tdsrWarning = document.getElementById('tdsrWarning');
            tdsrElement.textContent = tdsrRatio.toFixed(1) + '%';
            
            // Highlight TDSR based on 55% limit
            if (tdsrRatio > 55) {
                tdsrElement.style.color = '#d9534f'; // Red - exceeds limit
                tdsrElement.style.fontWeight = 'bold';
                tdsrWarning.style.display = 'block';
                tdsrWarning.style.color = '#d9534f';
                tdsrWarning.innerHTML = '‚ö†Ô∏è <strong>Exceeds 55% TDSR limit!</strong> Loan may not be approved.';
            } else if (tdsrRatio > 50) {
                tdsrElement.style.color = '#f0ad4e'; // Orange - getting close
                tdsrElement.style.fontWeight = 'bold';
                tdsrWarning.style.display = 'block';
                tdsrWarning.style.color = '#f0ad4e';
                tdsrWarning.innerHTML = '‚ö†Ô∏è Close to 55% limit. Consider reducing loan amount.';
            } else {
                tdsrElement.style.color = '#5cb85c'; // Green - safe zone
                tdsrElement.style.fontWeight = 'normal';
                tdsrWarning.style.display = 'none';
            }
            
            document.getElementById('cashPayment').textContent = formatCurrency(cashForDownPayment);

            // Generate payment schedule
            generatePaymentSchedule(loanAmount, monthlyRate, monthlyPayment, totalPayments);

            // Update chart
            updateChart(loanAmount, totalInterest, totalPayments, monthlyRate, monthlyPayment);
            
            // Enable save button now that calculation is complete
            enableSaveButton();
            
            // Update funding progress with total cash needed
            // totalCashNeeded = cash portion of down payment + BSD + ABSD (all must be in cash)
            updateFundingProgress(totalCashNeeded, cpfAvailable);
            
            // Update remaining cash needed display
            updateRemainingCashNeeded(totalCashNeeded);
        }

        function enableSaveButton() {
            const btnSave = document.getElementById('btnSaveScenario');
            if (btnSave) {
                btnSave.disabled = false;
            }
        }

        function updateRemainingCashNeeded(totalCashNeededValue = null) {
            try {
                let totalCashNeeded;
                
                // Get total cash needed from parameter or DOM
                if (totalCashNeededValue !== null) {
                    totalCashNeeded = totalCashNeededValue;
                } else {
                    // Read from DOM
                    const cashNeededElement = document.getElementById('cashNeeded');
                    if (!cashNeededElement || !cashNeededElement.textContent) {
                        return; // Skip if not calculated yet
                    }
                    const cashNeededText = cashNeededElement.textContent.replace(/[S$,]/g, '');
                    totalCashNeeded = parseFloat(cashNeededText);
                    if (isNaN(totalCashNeeded) || totalCashNeeded === 0) {
                        return;
                    }
                }
                
                // Get CPF amount
                const cpfInput = document.getElementById('cpfAvailable');
                const cpfAmount = cpfInput ? getNumericValue(cpfInput) : 0;
                
                // Get all funding sources
                let otherSourcesTotal = 0;
                const container = document.getElementById('fundingSourcesContainer');
                
                if (container) {
                    const sourceDivs = container.querySelectorAll('.funding-source-row');
                    sourceDivs.forEach(sourceDiv => {
                        const amountInput = sourceDiv.querySelector('[id^="fundingSourceAmount"]');
                        if (amountInput) {
                            const amount = getNumericValue(amountInput) || 0;
                            otherSourcesTotal += amount;
                        }
                    });
                }
                
                // Calculate remaining
                const totalSaved = cpfAmount + otherSourcesTotal;
                const remaining = Math.max(0, totalCashNeeded - totalSaved);
                
                // Update display
                const remainingElement = document.getElementById('remainingCashNeeded');
                if (remainingElement) {
                    if (remaining === 0) {
                        remainingElement.textContent = 'S$0';
                        remainingElement.style.color = '#34c759'; // Green
                        remainingElement.style.fontWeight = 'bold';
                    } else {
                        remainingElement.textContent = formatCurrency(remaining);
                        remainingElement.style.color = '#d9534f'; // Red
                        remainingElement.style.fontWeight = 'bold';
                    }
                }
            } catch (error) {
                console.error('Error updating remaining cash needed:', error);
            }
        }

        function generatePaymentSchedule(loanAmount, monthlyRate, monthlyPayment, totalPayments) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            let balance = loanAmount;
            const displayOption = document.getElementById('scheduleDisplay').value;
            const monthsToShow = displayOption === 'all' ? totalPayments : Math.min(parseInt(displayOption), totalPayments);

            for (let i = 1; i <= monthsToShow; i++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                const row = tbody.insertRow();
                row.insertCell(0).textContent = i;
                row.insertCell(1).textContent = formatCurrency(monthlyPayment);
                row.insertCell(2).textContent = formatCurrency(principalPayment);
                row.insertCell(3).textContent = formatCurrency(interestPayment);
                row.insertCell(4).textContent = formatCurrency(balance);
            }
        }

        function exportToCSV() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value);
            const loanTenure = parseFloat(document.getElementById('loanTenure').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;

            const downPayment = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPayment;
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTenure * 12;
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / 
                                   (Math.pow(1 + monthlyRate, totalPayments) - 1);

            // Generate full schedule for CSV
            let csvContent = "Month,Payment,Principal,Interest,Balance\n";
            let balance = loanAmount;

            for (let i = 1; i <= totalPayments; i++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                csvContent += `${i},${monthlyPayment.toFixed(2)},${principalPayment.toFixed(2)},${interestPayment.toFixed(2)},${balance.toFixed(2)}\n`;
            }

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'condo_payment_schedule.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateChart(loanAmount, totalInterest, totalPayments, monthlyRate, monthlyPayment) {
            const years = Math.ceil(totalPayments / 12);
            const labels = [];
            const principalData = [];
            const interestData = [];
            let balance = loanAmount;
            let totalPrincipalPaid = 0;
            let totalInterestPaid = 0;

            for (let year = 0; year <= years; year++) {
                labels.push('Year ' + year);
                principalData.push(totalPrincipalPaid);
                interestData.push(totalInterestPaid);

                // Calculate payments for the next year
                const paymentsThisYear = Math.min(12, totalPayments - (year * 12));
                for (let month = 0; month < paymentsThisYear; month++) {
                    const interestPayment = balance * monthlyRate;
                    const principalPayment = monthlyPayment - interestPayment;
                    balance -= principalPayment;
                    totalPrincipalPaid += principalPayment;
                    totalInterestPaid += interestPayment;
                }
            }

            if (paymentChart) {
                paymentChart.destroy();
            }

            const ctx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Principal Paid',
                        data: principalData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Interest Paid',
                        data: interestData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S$' + (value/1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funding Sources Management
        let fundingSourceCounter = 0;
        let fundingSourcesExpanded = false;

        function toggleFundingSources() {
            fundingSourcesExpanded = !fundingSourcesExpanded;
            const panel = document.getElementById('fundingSourcesPanel');
            const icon = document.getElementById('fundingToggleIcon');
            
            if (fundingSourcesExpanded) {
                panel.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                panel.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function addFundingSource() {
            fundingSourceCounter++;
            const container = document.getElementById('fundingSourcesContainer');
            
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'funding-source-row';
            sourceDiv.id = `fundingSource${fundingSourceCounter}`;
            
            sourceDiv.innerHTML = `
                <input type="text" 
                       id="fundingSourceName${fundingSourceCounter}" 
                       placeholder="Source name (e.g., Cash Savings, Stock, Gift)" 
                       style="flex: 1;">
                <input type="text" 
                       id="fundingSourceAmount${fundingSourceCounter}" 
                       placeholder="Amount" 
                       oninput="formatNumberInput(this); updateFundingProgress();" 
                       style="flex: 1;">
                <button type="button" onclick="removeFundingSource(${fundingSourceCounter})">Remove</button>
            `;
            
            container.appendChild(sourceDiv);
        }

        function addFundingSourceTemplate(templateName) {
            fundingSourceCounter++;
            const container = document.getElementById('fundingSourcesContainer');
            
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'funding-source-row';
            sourceDiv.id = `fundingSource${fundingSourceCounter}`;
            
            sourceDiv.innerHTML = `
                <input type="text" 
                       id="fundingSourceName${fundingSourceCounter}" 
                       value="${templateName}"
                       placeholder="Source name" 
                       style="flex: 1;">
                <input type="text" 
                       id="fundingSourceAmount${fundingSourceCounter}" 
                       placeholder="Amount" 
                       oninput="formatNumberInput(this); updateFundingProgress();" 
                       style="flex: 1;">
                <button type="button" onclick="removeFundingSource(${fundingSourceCounter})">Remove</button>
            `;
            
            container.appendChild(sourceDiv);
            
            // Focus on amount field for immediate input
            setTimeout(() => {
                document.getElementById(`fundingSourceAmount${fundingSourceCounter}`).focus();
            }, 100);
        }

        function removeFundingSource(id) {
            const element = document.getElementById(`fundingSource${id}`);
            if (element) {
                element.remove();
                updateFundingProgress();
            }
        }

        function updateFundingProgress(totalUpfrontValue = null, cpfValue = null) {
            try {
                // Use passed values or read from DOM
                let totalUpfront, cpfAmount;
                
                if (totalUpfrontValue !== null && cpfValue !== null) {
                    // Values passed directly from calculate()
                    totalUpfront = totalUpfrontValue;
                    cpfAmount = cpfValue;
                    console.log('Using passed values - CPF:', cpfAmount, 'Total Upfront (DP + BSD + ABSD):', totalUpfront);
                } else {
                    // Read from DOM elements (when called from input changes)
                    // Total Upfront = Down Payment + Total Stamp Duty
                    const downPaymentElement = document.getElementById('downPaymentAmount');
                    const stampDutyElement = document.getElementById('totalStampDuty');
                    
                    if (!downPaymentElement || !downPaymentElement.textContent || 
                        !stampDutyElement || !stampDutyElement.textContent) {
                        return; // Skip if no calculation done yet
                    }
                    
                    const downPaymentText = downPaymentElement.textContent.replace(/[S$,]/g, '');
                    const stampDutyText = stampDutyElement.textContent.replace(/[S$,]/g, '');
                    
                    const downPayment = parseFloat(downPaymentText);
                    const stampDuty = parseFloat(stampDutyText);
                    
                    if (isNaN(downPayment) || isNaN(stampDuty)) {
                        return;
                    }
                    
                    totalUpfront = downPayment + stampDuty;
                    
                    // Get CPF amount from input
                    const cpfInput = document.getElementById('cpfAvailable');
                    cpfAmount = cpfInput ? getNumericValue(cpfInput) : 0;
                    console.log('Using DOM values - CPF:', cpfAmount, 'Total Upfront (DP + BSD + ABSD):', totalUpfront);
                }
                
                // Get all funding sources
                let otherSourcesTotal = 0;
                const container = document.getElementById('fundingSourcesContainer');
                
                if (container) {
                    const sourceDivs = container.querySelectorAll('.funding-source-row');
                    sourceDivs.forEach(sourceDiv => {
                        const amountInput = sourceDiv.querySelector('[id^="fundingSourceAmount"]');
                        if (amountInput) {
                            const amount = getNumericValue(amountInput) || 0;
                            otherSourcesTotal += amount;
                        }
                    });
                }
                
                // Calculate percentages based on total upfront amount (DP + BSD + ABSD)
                const totalSaved = cpfAmount + otherSourcesTotal;
                const cpfPercent = Math.min((cpfAmount / totalUpfront) * 100, 100);
                const otherPercent = Math.min((otherSourcesTotal / totalUpfront) * 100, 100);
                const totalPercent = Math.min((totalSaved / totalUpfront) * 100, 100);
                
                console.log('Progress Update - CPF%:', cpfPercent.toFixed(1), 'Other%:', otherPercent.toFixed(1), 'Total%:', totalPercent.toFixed(1));
                
                // Update progress bar segments
                const cpfSegment = document.getElementById('progressCPF');
                const sourcesSegment = document.getElementById('progressSources');
                
                if (cpfSegment) {
                    cpfSegment.style.width = cpfPercent + '%';
                    const cpfLabel = cpfSegment.querySelector('.progress-label');
                    if (cpfLabel) {
                        cpfLabel.textContent = cpfPercent > 5 ? `CPF: ${cpfPercent.toFixed(0)}%` : '';
                    }
                } else {
                    console.warn('CPF segment not found!');
                }
                
                if (sourcesSegment) {
                    sourcesSegment.style.width = otherPercent + '%';
                    const sourcesLabel = sourcesSegment.querySelector('.progress-label');
                    if (sourcesLabel) {
                        sourcesLabel.textContent = otherPercent > 5 ? `Other: ${otherPercent.toFixed(0)}%` : '';
                    }
                } else {
                    console.warn('Sources segment not found!');
                }
                
                // Update summary
                const summary = document.getElementById('progressSummary');
                if (summary) {
                    const remainingAmount = Math.max(0, totalUpfront - totalSaved);
                    
                    if (totalPercent >= 100) {
                        summary.innerHTML = `<strong style="color: #34c759;">‚úì Fully Funded!</strong> Total: ${totalPercent.toFixed(0)}% (${formatCurrency(totalSaved)} / ${formatCurrency(totalUpfront)})`;
                    } else {
                        summary.innerHTML = `Total: ${totalPercent.toFixed(0)}% (${formatCurrency(totalSaved)} / ${formatCurrency(totalUpfront)}) ‚Ä¢ <span style="color: #d9534f;">Need: ${formatCurrency(remainingAmount)}</span>`;
                    }
                }
            } catch (error) {
                console.error('Error updating funding progress:', error);
            }
            
            // Also update remaining cash needed
            updateRemainingCashNeeded();
        }

        // Calculate on page load
        calculate();
        updateMaxTenure();
        validateDownPayment();

        // Saved Scenarios Management
        let savedScenarios = JSON.parse(localStorage.getItem('propertyScenarios') || '[]');
        let currentDeleteId = null;
        let comparisonViewMode = localStorage.getItem('comparisonViewMode') || 'cards'; // 'cards' or 'table'

        // Custom Modal Functions
        function showInputModal(callback) {
            const modal = document.getElementById('inputModal');
            const input = document.getElementById('scenarioNameInput');
            input.value = `Scenario ${savedScenarios.length + 1}`;
            modal.classList.add('active');
            input.focus();
            input.select();
            
            // Store callback for later
            window.inputModalCallback = callback;
            
            // Handle Enter key
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    confirmSaveScenario();
                }
            };
        }

        function closeInputModal() {
            document.getElementById('inputModal').classList.remove('active');
            window.inputModalCallback = null;
        }

        function confirmSaveScenario() {
            const input = document.getElementById('scenarioNameInput');
            const value = input.value.trim();
            if (value && window.inputModalCallback) {
                window.inputModalCallback(value);
            }
            closeInputModal();
        }

        function showAlert(message, icon = '‚úÖ') {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertIcon').textContent = icon;
            modal.classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }

        function showConfirm(message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').textContent = message;
            modal.classList.add('active');
            window.confirmModalCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            window.confirmModalCallback = null;
        }

        function confirmAction() {
            if (window.confirmModalCallback) {
                window.confirmModalCallback();
            }
            closeConfirmModal();
        }

        function saveScenario() {
            // Better validation: Check if calculation has been performed
            // by verifying the monthly payment is a valid number
            const monthlyPaymentEl = document.getElementById('monthlyPayment');
            const monthlyPaymentText = monthlyPaymentEl ? monthlyPaymentEl.textContent : '';
            const monthlyPaymentValue = parseFloat(monthlyPaymentText.replace(/[S$,]/g, ''));
            
            // Check if we have a valid calculated value (not NaN and greater than 0)
            if (isNaN(monthlyPaymentValue) || monthlyPaymentValue <= 0) {
                showAlert('Please click "Calculate Payment Plan" first before saving!', '‚ö†Ô∏è');
                return;
            }

            showInputModal((scenarioName) => {
                if (!scenarioName) return;

                try {
                    const scenario = {
                        id: Date.now(),
                        name: scenarioName,
                        timestamp: new Date().toISOString(),
                        data: {
                            // User Profile
                            age: parseInt(document.getElementById('age').value),
                            monthlyIncome: getNumericValue(document.getElementById('monthlyIncome')),
                            cpfAvailable: getNumericValue(document.getElementById('cpfAvailable')),
                            monthlyCPF: getNumericValue(document.getElementById('monthlyCPF')),
                            buyerProfile: document.getElementById('buyerProfile').value,
                            
                            // Purchase Details
                            propertyType: document.getElementById('propertyType').value,
                            propertyPrice: getNumericValue(document.getElementById('propertyPrice')),
                            downPaymentPercent: parseFloat(document.getElementById('downPaymentPercent').value),
                            loanTenure: parseFloat(document.getElementById('loanTenure').value),
                            interestRate: parseFloat(document.getElementById('interestRate').value),
                            loanType: document.getElementById('loanType').value,
                        },
                        results: {
                            downPayment: parseFloat(document.getElementById('downPaymentAmount').textContent.replace(/[S$,]/g, '')),
                            loanAmount: parseFloat(document.getElementById('loanAmount').textContent.replace(/[S$,]/g, '')),
                            monthlyPayment: monthlyPaymentValue,
                            totalInterest: parseFloat(document.getElementById('totalInterest').textContent.replace(/[S$,]/g, '')),
                            stampDuty: parseFloat(document.getElementById('stampDuty').textContent.replace(/[S$,]/g, '')),
                            absdAmount: parseFloat(document.getElementById('absdAmount').textContent.replace(/[S$,]/g, '')),
                            totalStampDuty: parseFloat(document.getElementById('totalStampDuty').textContent.replace(/[S$,]/g, '')),
                            cashNeeded: parseFloat(document.getElementById('cashNeeded').textContent.replace(/[S$,]/g, '')),
                            tdsrRatio: parseFloat(document.getElementById('tdsrRatio').textContent.replace(/%/g, ''))
                        }
                    };

                    savedScenarios.push(scenario);
                    localStorage.setItem('propertyScenarios', JSON.stringify(savedScenarios));
                    
                    updateSavedScenariosList();
                    updateCompareButton();
                    
                    // Scroll to saved scenarios section
                    document.getElementById('savedScenariosPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    showAlert(`Scenario "${scenarioName}" saved successfully!`, '‚úÖ');
                } catch (error) {
                    console.error('Error saving scenario:', error);
                    showAlert('Error saving scenario. Please try again.', '‚ùå');
                }
            });
        }

        function updateSavedScenariosList() {
            const panel = document.getElementById('savedScenariosPanel');
            const list = document.getElementById('savedScenariosList');
            
            if (savedScenarios.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-state-icon">üíæ</div>
                        <p style="color: #999; font-size: 0.9em;">No saved scenarios yet. Click "Save Scenario" to start comparing properties!</p>
                    </div>
                `;
                return;
            }

            panel.style.display = 'block';
            
            list.innerHTML = savedScenarios.map(scenario => {
                const propertyTypeLabel = scenario.data.propertyType === 'hdb' ? 'HDB' : 'Condo';
                return `
                    <div class="scenario-item">
                        <div class="scenario-info">
                            <div class="scenario-name">${scenario.name}</div>
                            <div class="scenario-details">
                                ${propertyTypeLabel} ‚Ä¢ ${formatCurrency(scenario.data.propertyPrice)} ‚Ä¢ 
                                Monthly: ${formatCurrency(scenario.results.monthlyPayment)}
                            </div>
                        </div>
                        <div class="scenario-actions">
                            <button class="btn-icon btn-load" onclick="loadScenario(${scenario.id})" title="Load">
                                üìÇ Load
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteScenario(${scenario.id})" title="Delete">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadScenario(id) {
            const scenario = savedScenarios.find(s => s.id === id);
            if (!scenario) return;

            // Load User Profile
            document.getElementById('age').value = scenario.data.age;
            document.getElementById('monthlyIncome').value = scenario.data.monthlyIncome.toLocaleString('en-SG');
            document.getElementById('cpfAvailable').value = scenario.data.cpfAvailable.toLocaleString('en-SG');
            document.getElementById('monthlyCPF').value = scenario.data.monthlyCPF.toLocaleString('en-SG');
            document.getElementById('buyerProfile').value = scenario.data.buyerProfile;

            // Load Purchase Details
            document.getElementById('propertyType').value = scenario.data.propertyType;
            document.getElementById('propertyPrice').value = scenario.data.propertyPrice.toLocaleString('en-SG');
            document.getElementById('downPaymentPercent').value = scenario.data.downPaymentPercent;
            document.getElementById('loanTenure').value = scenario.data.loanTenure;
            document.getElementById('interestRate').value = scenario.data.interestRate;
            document.getElementById('loanType').value = scenario.data.loanType;

            // Update dependent fields
            updatePropertyType();
            updateMaxTenure();
            validateDownPayment();
            calculate();

            showAlert(`Loaded scenario: ${scenario.name}`, '‚úÖ');
        }

        function deleteScenario(id) {
            const scenario = savedScenarios.find(s => s.id === id);
            if (!scenario) return;

            showConfirm(`Are you sure you want to delete "${scenario.name}"?`, () => {
                savedScenarios = savedScenarios.filter(s => s.id !== id);
                localStorage.setItem('propertyScenarios', JSON.stringify(savedScenarios));
                
                updateSavedScenariosList();
                updateCompareButton();
                
                showAlert('Scenario deleted successfully!', 'üóëÔ∏è');
            });
        }

        function updateCompareButton() {
            const btnCompare = document.getElementById('btnCompare');
            btnCompare.disabled = savedScenarios.length < 2;
        }

        function openCompareModal() {
            if (savedScenarios.length < 2) {
                showAlert('Please save at least 2 scenarios to compare.', '‚ÑπÔ∏è');
                return;
            }

            const modal = document.getElementById('comparisonModal');
            const content = document.getElementById('comparisonContent');

            // Generate streamlined comparison with PropertyPlan SG branding
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <div>
                        <h2 style="margin: 0; color: #667eea; font-size: 1.8em;">üè† PropertyPlan SG</h2>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.95em;">Compare Property Scenarios</p>
                    </div>
                    <div class="view-toggle">
                        <button class="view-toggle-btn ${comparisonViewMode === 'cards' ? 'active' : ''}" onclick="switchComparisonView('cards')">
                            <span>üé¥</span> Classic
                        </button>
                        <button class="view-toggle-btn ${comparisonViewMode === 'table' ? 'active' : ''}" onclick="switchComparisonView('table')">
                            <span>üìã</span> Compact
                        </button>
                    </div>
                </div>
                
                <div class="comparison-selector">
                    ${savedScenarios.map((s, index) => {
                        const propertyType = s.data.propertyType === 'hdb' ? 'HDB' : 'Condo';
                        return `
                            <label class="scenario-select-card ${index < 3 ? 'selected' : ''}" for="scenario-${s.id}">
                                <input type="checkbox" class="scenario-checkbox" id="scenario-${s.id}" value="${s.id}" 
                                       ${index < 3 ? 'checked' : ''} onchange="updateComparison(event)">
                                <span><strong>${s.name}</strong> ¬∑ ${propertyType} ¬∑ ${formatCurrency(s.data.propertyPrice)}</span>
                            </label>
                        `;
                    }).join('')}
                </div>
                
                <div id="comparisonCardsContainer"></div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button class="btn-export" onclick="exportComparison()">
                        <span style="font-size: 1.2em;">üì•</span> Export to CSV
                    </button>
                </div>
            `;

            modal.classList.add('active');
            updateComparison();
        }

        function switchComparisonView(mode) {
            comparisonViewMode = mode;
            localStorage.setItem('comparisonViewMode', mode);
            
            // Update button states
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.view-toggle-btn').classList.add('active');
            
            // Refresh comparison
            updateComparison();
        }

        function exportComparison() {
            const checkboxes = document.querySelectorAll('.scenario-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const selectedScenarios = savedScenarios.filter(s => selectedIds.includes(s.id));

            if (selectedScenarios.length === 0) {
                showAlert('Please select at least one scenario to export.', '‚ÑπÔ∏è');
                return;
            }

            const propertyTypeLabels = {
                'hdb': 'HDB Flat',
                'condo': 'Private Condo'
            };

            const buyerProfileLabels = {
                'sc_first': 'SC - 1st Property',
                'sc_second': 'SC - 2nd Property',
                'sc_third': 'SC - 3rd+ Property',
                'pr_first': 'PR - 1st Property',
                'pr_second': 'PR - 2nd+ Property',
                'foreigner': 'Foreigner',
                'entity': 'Entity'
            };

            // Build CSV content
            let csv = 'PropertyPlan SG - Scenario Comparison\n';
            csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
            
            // Header row with scenario names
            csv += 'Metric,' + selectedScenarios.map(s => s.name).join(',') + '\n';
            
            // Property Details
            csv += '\nProperty Details\n';
            csv += 'Property Type,' + selectedScenarios.map(s => propertyTypeLabels[s.data.propertyType]).join(',') + '\n';
            csv += 'Property Price,' + selectedScenarios.map(s => s.data.propertyPrice).join(',') + '\n';
            csv += 'Buyer Profile,' + selectedScenarios.map(s => buyerProfileLabels[s.data.buyerProfile]).join(',') + '\n';
            
            // Loan Details
            csv += '\nLoan Details\n';
            csv += 'Down Payment %,' + selectedScenarios.map(s => s.data.downPaymentPercent + '%').join(',') + '\n';
            csv += 'Down Payment Amount,' + selectedScenarios.map(s => s.results.downPayment).join(',') + '\n';
            csv += 'Loan Amount,' + selectedScenarios.map(s => s.results.loanAmount).join(',') + '\n';
            csv += 'Loan Tenure (years),' + selectedScenarios.map(s => s.data.loanTenure).join(',') + '\n';
            csv += 'Interest Rate,' + selectedScenarios.map(s => s.data.interestRate + '%').join(',') + '\n';
            
            // Monthly Costs
            csv += '\nMonthly Costs\n';
            csv += 'Monthly Payment,' + selectedScenarios.map(s => s.results.monthlyPayment.toFixed(2)).join(',') + '\n';
            csv += 'TDSR Ratio,' + selectedScenarios.map(s => s.results.tdsrRatio.toFixed(1) + '%').join(',') + '\n';
            
            // Upfront Costs
            csv += '\nUpfront Costs\n';
            csv += 'Buyer\'s Stamp Duty (BSD),' + selectedScenarios.map(s => s.results.stampDuty).join(',') + '\n';
            csv += 'Additional BSD (ABSD),' + selectedScenarios.map(s => s.results.absdAmount).join(',') + '\n';
            csv += 'Total Cash Needed,' + selectedScenarios.map(s => s.results.cashNeeded).join(',') + '\n';
            
            // Total Costs
            csv += '\nTotal Costs\n';
            csv += 'Total Interest Paid,' + selectedScenarios.map(s => s.results.totalInterest.toFixed(2)).join(',') + '\n';
            csv += 'Total Payment (Price + Interest),' + selectedScenarios.map(s => (s.data.propertyPrice + s.results.totalInterest).toFixed(2)).join(',') + '\n';
            
            // Best Values Summary
            csv += '\nBest Values (Lowest)\n';
            const monthlyPayments = selectedScenarios.map(s => s.results.monthlyPayment);
            const downPayments = selectedScenarios.map(s => s.results.downPayment);
            const totalInterests = selectedScenarios.map(s => s.results.totalInterest);
            const cashNeeded = selectedScenarios.map(s => s.results.cashNeeded);
            const tdsrRatios = selectedScenarios.map(s => s.results.tdsrRatio);
            const totalCosts = selectedScenarios.map(s => s.data.propertyPrice + s.results.totalInterest);
            
            csv += 'Best Monthly Payment,' + selectedScenarios.map(s => s.results.monthlyPayment === Math.min(...monthlyPayments) ? '‚úì' : '').join(',') + '\n';
            csv += 'Best Down Payment,' + selectedScenarios.map(s => s.results.downPayment === Math.min(...downPayments) ? '‚úì' : '').join(',') + '\n';
            csv += 'Best Total Interest,' + selectedScenarios.map(s => s.results.totalInterest === Math.min(...totalInterests) ? '‚úì' : '').join(',') + '\n';
            csv += 'Best Cash Needed,' + selectedScenarios.map(s => s.results.cashNeeded === Math.min(...cashNeeded) ? '‚úì' : '').join(',') + '\n';
            csv += 'Best TDSR Ratio,' + selectedScenarios.map(s => s.results.tdsrRatio === Math.min(...tdsrRatios) ? '‚úì' : '').join(',') + '\n';
            csv += 'Best Total Payment,' + selectedScenarios.map(s => (s.data.propertyPrice + s.results.totalInterest) === Math.min(...totalCosts) ? '‚úì' : '').join(',') + '\n';

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute('href', url);
            link.setAttribute('download', `propertyplan_sg_comparison_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Comparison exported successfully!', '‚úÖ');
        }

        function toggleScenarioCard(card) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
            updateComparison();
        }

        function closeCompareModal() {
            const modal = document.getElementById('comparisonModal');
            modal.classList.remove('active');
        }

        function updateComparison(event) {
            if (event) {
                event.stopPropagation();
                // Toggle selected class on parent label
                const checkbox = event.target;
                const label = checkbox.closest('.scenario-select-card');
                if (label) {
                    label.classList.toggle('selected', checkbox.checked);
                }
            }
            
            const checkboxes = document.querySelectorAll('.scenario-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const selectedScenarios = savedScenarios.filter(s => selectedIds.includes(s.id));

            const container = document.getElementById('comparisonCardsContainer');

            if (selectedScenarios.length === 0) {
                container.innerHTML = `
                    <div class="no-scenarios-selected">
                        <div class="no-scenarios-selected-icon">üìä</div>
                        <p>Select at least one scenario to compare</p>
                    </div>
                `;
                return;
            }

            // Render based on view mode
            if (comparisonViewMode === 'table') {
                renderTableView(selectedScenarios, container);
            } else {
                renderCardsView(selectedScenarios, container);
            }
        }

        function renderCardsView(selectedScenarios, container) {
            // Determine grid class based on number of scenarios
            let gridClass = '';
            if (selectedScenarios.length === 3) gridClass = 'three-col';
            if (selectedScenarios.length >= 4) gridClass = 'four-col';

            // Find best values for highlighting
            const monthlyPayments = selectedScenarios.map(s => s.results.monthlyPayment);
            const totalInterests = selectedScenarios.map(s => s.results.totalInterest);
            const cashNeeded = selectedScenarios.map(s => s.results.cashNeeded);
            const tdsrRatios = selectedScenarios.map(s => s.results.tdsrRatio);
            const totalCosts = selectedScenarios.map(s => s.data.propertyPrice + s.results.totalInterest);
            const downPayments = selectedScenarios.map(s => s.results.downPayment);
            
            const bestMonthly = Math.min(...monthlyPayments);
            const bestInterest = Math.min(...totalInterests);
            const bestCash = Math.min(...cashNeeded);
            const bestTdsr = Math.min(...tdsrRatios);
            const bestTotalCost = Math.min(...totalCosts);
            const bestDownPayment = Math.min(...downPayments); // Lower down payment is better (more leverage)

            const propertyTypeLabels = {
                'hdb': 'HDB Flat',
                'condo': 'Private Condo'
            };

            const html = `
                <div class="comparison-grid ${gridClass}">
                    ${selectedScenarios.map(scenario => {
                        const propertyType = propertyTypeLabels[scenario.data.propertyType];
                        const totalCost = scenario.data.propertyPrice + scenario.results.totalInterest;
                        const isBestMonthly = scenario.results.monthlyPayment === bestMonthly;
                        const isBestInterest = scenario.results.totalInterest === bestInterest;
                        const isBestCash = scenario.results.cashNeeded === bestCash;
                        const isBestTdsr = scenario.results.tdsrRatio === bestTdsr;
                        const isBestTotalCost = totalCost === bestTotalCost;
                        const isBestDownPayment = scenario.results.downPayment === bestDownPayment;
                        
                        // Count "best" badges
                        const bestCount = [isBestMonthly, isBestInterest, isBestCash, isBestTdsr, isBestTotalCost, isBestDownPayment].filter(Boolean).length;
                        
                        return `
                            <div class="comparison-card">
                                ${bestCount >= 2 ? '<div class="comparison-badge">Best Value</div>' : ''}
                                
                                <div class="comparison-card-header">
                                    <div class="comparison-card-title">${scenario.name}</div>
                                    <div class="comparison-card-subtitle">${propertyType}</div>
                                    <div class="comparison-card-price">${formatCurrency(scenario.data.propertyPrice)}</div>
                                </div>
                                
                                <div class="comparison-card-body">
                                    <div class="comparison-monthly-payment">
                                        <div class="comparison-monthly-label">Monthly Payment</div>
                                        <div class="comparison-monthly-value ${isBestMonthly ? 'best' : ''}">${formatCurrency(scenario.results.monthlyPayment)}</div>
                                    </div>
                                    
                                    <div class="comparison-section">
                                        <div class="comparison-section-title">Loan Details</div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Down Payment</span>
                                            <span class="comparison-feature-value ${isBestDownPayment ? 'best' : ''}">${scenario.data.downPaymentPercent}% ¬∑ ${formatCurrency(scenario.results.downPayment)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Loan Amount</span>
                                            <span class="comparison-feature-value">${formatCurrency(scenario.results.loanAmount)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Interest Rate</span>
                                            <span class="comparison-feature-value">${scenario.data.interestRate}%</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Loan Tenure</span>
                                            <span class="comparison-feature-value">${scenario.data.loanTenure} years</span>
                                        </div>
                                    </div>
                                    
                                    <div class="comparison-section">
                                        <div class="comparison-section-title">Financial Impact</div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Total Interest</span>
                                            <span class="comparison-feature-value ${isBestInterest ? 'best' : ''}">${formatCurrency(scenario.results.totalInterest)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Total Payment</span>
                                            <span class="comparison-feature-value ${isBestTotalCost ? 'best' : ''}">${formatCurrency(totalCost)}</span>
                                        </div>
                                        <div class="comparison-feature" style="font-size: 0.85em; color: #86868b; padding-left: 10px;">
                                            <span class="comparison-feature-label">‚îî Property Price</span>
                                            <span class="comparison-feature-value">${formatCurrency(scenario.data.propertyPrice)}</span>
                                        </div>
                                        <div class="comparison-feature" style="font-size: 0.85em; color: #86868b; padding-left: 10px; border-bottom: none;">
                                            <span class="comparison-feature-label">‚îî Interest Paid</span>
                                            <span class="comparison-feature-value">${formatCurrency(scenario.results.totalInterest)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">TDSR Ratio</span>
                                            <span class="comparison-feature-value ${isBestTdsr ? 'best' : ''}">${scenario.results.tdsrRatio.toFixed(1)}%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="comparison-section">
                                        <div class="comparison-section-title">Upfront Costs</div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">BSD</span>
                                            <span class="comparison-feature-value">${formatCurrency(scenario.results.stampDuty)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">ABSD</span>
                                            <span class="comparison-feature-value">${formatCurrency(scenario.results.absdAmount)}</span>
                                        </div>
                                        <div class="comparison-feature">
                                            <span class="comparison-feature-label">Total Cash Needed</span>
                                            <span class="comparison-feature-value ${isBestCash ? 'best' : ''}">${formatCurrency(scenario.results.cashNeeded)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        function renderTableView(selectedScenarios, container) {
            const propertyTypeLabels = {
                'hdb': 'HDB Flat',
                'condo': 'Private Condo'
            };

            const buyerProfileLabels = {
                'sc_first': 'SC - 1st Property',
                'sc_second': 'SC - 2nd Property',
                'sc_third': 'SC - 3rd+ Property',
                'pr_first': 'PR - 1st Property',
                'pr_second': 'PR - 2nd+ Property',
                'foreigner': 'Foreigner',
                'entity': 'Entity'
            };

            const html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            ${selectedScenarios.map(s => `<th>${s.name}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="${selectedScenarios.length + 1}" class="row-header">Property Details</td></tr>
                        <tr>
                            <td>Property Type</td>
                            ${selectedScenarios.map(s => `<td>${propertyTypeLabels[s.data.propertyType]}</td>`).join('')}
                        </tr>
                        <tr>
                            <td>Property Price</td>
                            ${selectedScenarios.map(s => `<td>${formatCurrency(s.data.propertyPrice)}</td>`).join('')}
                        </tr>
                        <tr>
                            <td>Buyer Profile</td>
                            ${selectedScenarios.map(s => `<td>${buyerProfileLabels[s.data.buyerProfile]}</td>`).join('')}
                        </tr>
                        
                        <tr><td colspan="${selectedScenarios.length + 1}" class="row-header">Loan Details</td></tr>
                        <tr>
                            <td>Down Payment %</td>
                            ${selectedScenarios.map(s => `<td>${s.data.downPaymentPercent}%</td>`).join('')}
                        </tr>
                        <tr>
                            <td><strong>Down Payment Amount</strong></td>
                            ${highlightBest(selectedScenarios.map(s => s.results.downPayment), false)}
                        </tr>
                        <tr>
                            <td>Loan Amount</td>
                            ${selectedScenarios.map(s => `<td>${formatCurrency(s.results.loanAmount)}</td>`).join('')}
                        </tr>
                        <tr>
                            <td>Loan Tenure</td>
                            ${selectedScenarios.map(s => `<td>${s.data.loanTenure} years</td>`).join('')}
                        </tr>
                        <tr>
                            <td>Interest Rate</td>
                            ${selectedScenarios.map(s => `<td>${s.data.interestRate}%</td>`).join('')}
                        </tr>
                        
                        <tr><td colspan="${selectedScenarios.length + 1}" class="row-header">Monthly Costs</td></tr>
                        <tr>
                            <td><strong>Monthly Payment</strong></td>
                            ${highlightBest(selectedScenarios.map(s => s.results.monthlyPayment), false)}
                        </tr>
                        <tr>
                            <td>TDSR Ratio</td>
                            ${highlightBest(selectedScenarios.map(s => s.results.tdsrRatio), false, '%')}
                        </tr>
                        
                        <tr><td colspan="${selectedScenarios.length + 1}" class="row-header">Upfront Costs</td></tr>
                        <tr>
                            <td>Buyer's Stamp Duty (BSD)</td>
                            ${selectedScenarios.map(s => `<td>${formatCurrency(s.results.stampDuty)}</td>`).join('')}
                        </tr>
                        <tr>
                            <td>Additional BSD (ABSD)</td>
                            ${selectedScenarios.map(s => `<td>${formatCurrency(s.results.absdAmount)}</td>`).join('')}
                        </tr>
                        <tr>
                            <td><strong>Total Cash Needed</strong></td>
                            ${highlightBest(selectedScenarios.map(s => s.results.cashNeeded), false)}
                        </tr>
                        
                        <tr><td colspan="${selectedScenarios.length + 1}" class="row-header">Total Costs</td></tr>
                        <tr>
                            <td><strong>Total Interest Paid</strong></td>
                            ${highlightBest(selectedScenarios.map(s => s.results.totalInterest), false)}
                        </tr>
                        <tr>
                            <td><strong>Total Payment (Price + Interest)</strong></td>
                            ${highlightBest(selectedScenarios.map(s => s.data.propertyPrice + s.results.totalInterest), false)}
                        </tr>
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function highlightBest(values, higherIsBetter = true, suffix = '') {
            const bestValue = higherIsBetter ? Math.max(...values) : Math.min(...values);
            return values.map(v => {
                const isBest = v === bestValue;
                const displayValue = suffix ? `${v}${suffix}` : formatCurrency(v);
                return `<td${isBest ? ' class="highlight-best"' : ''}>${displayValue}</td>`;
            }).join('');
        }

        // Initialize on load
        updateSavedScenariosList();
        updateCompareButton();

        // Close modals when clicking outside or pressing Escape
        window.onclick = function(event) {
            const comparisonModal = document.getElementById('comparisonModal');
            const inputModal = document.getElementById('inputModal');
            const alertModal = document.getElementById('alertModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === comparisonModal) {
                closeCompareModal();
            }
            if (event.target === inputModal) {
                closeInputModal();
            }
            if (event.target === alertModal) {
                closeAlertModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }

        // Keyboard support for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCompareModal();
                closeInputModal();
                closeAlertModal();
                closeConfirmModal();
            }
            
            // Enter key for alert modal
            if (event.key === 'Enter') {
                const alertModal = document.getElementById('alertModal');
                if (alertModal.classList.contains('active')) {
                    closeAlertModal();
                }
            }
        });
    </script>
</body>
</html>
