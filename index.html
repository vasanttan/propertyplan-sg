<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyPlan SG - Singapore Property Purchase Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .brand {
            font-weight: 700;
            color: white;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 100%;
        }

        @media (min-width: 600px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (min-width: 1200px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (min-width: 1600px) {
            .summary-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .summary-item label {
            display: block;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .payment-schedule {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .payment-schedule table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-schedule th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .payment-schedule td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .payment-schedule tr:hover {
            background: #f8f9fa;
        }

        .info-badge {
            display: inline-block;
            background: #ffeaa7;
            color: #333;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 15px;
        }

        .display-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .display-selector label {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
        }

        .display-selector select {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .display-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-export:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† <span class="brand">PropertyPlan SG</span></h1>
            <p id="subtitle">Plan and track your S$1.3M property investment</p>
        </div>

        <div class="dashboard">
            <!-- Input Card -->
            <div class="card">
                <h2>User Profile</h2>
                
                <div class="input-group">
                    <label>Your Current Age</label>
                    <input type="number" id="age" value="35" min="21" max="64" oninput="updateMaxTenure()">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        üìÖ Used to calculate maximum loan tenure
                    </small>
                </div>

                <div class="input-group">
                    <label>Monthly Household Income (SGD)</label>
                    <input type="text" id="monthlyIncome" value="15,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>CPF Available for Down Payment (SGD)</label>
                    <input type="text" id="cpfAvailable" value="100,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>Monthly CPF Contribution for Mortgage (SGD)</label>
                    <input type="text" id="monthlyCPF" value="2,000" oninput="formatNumberInput(this)">
                </div>

                <div class="input-group">
                    <label>Buyer Profile</label>
                    <select id="buyerProfile" onchange="updateABSD()">
                        <option value="sc_first">Singapore Citizen - 1st Property</option>
                        <option value="sc_second">Singapore Citizen - 2nd Property</option>
                        <option value="sc_third">Singapore Citizen - 3rd+ Property</option>
                        <option value="pr_first">PR - 1st Property</option>
                        <option value="pr_second">PR - 2nd+ Property</option>
                        <option value="foreigner">Foreigner</option>
                        <option value="entity">Entity (Company/Trust)</option>
                    </select>
                </div>

                <div class="input-group" id="entityTypeGroup" style="display: none;">
                    <label>Entity Type</label>
                    <select id="entityType" onchange="updateABSD()">
                        <option value="housing_developer">Housing Developer</option>
                        <option value="other_entity">Other Entity</option>
                    </select>
                </div>

                <div class="info-badge" id="absdInfo" style="background: #d4edda;">
                    üèõÔ∏è ABSD: 0% (No additional stamp duty)
                </div>
            </div>

            <!-- Purchase Details Card -->
            <div class="card">
                <h2>Purchase Details</h2>
                
                <div class="input-group">
                    <label>Property Type</label>
                    <select id="propertyType" onchange="updatePropertyType()">
                        <option value="condo">Private Condo (Resale)</option>
                        <option value="hdb">HDB Flat (Resale)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Property Price (SGD)</label>
                    <input type="text" id="propertyPrice" value="1,300,000" oninput="formatNumberInput(this); updateSubtitle(); validateDownPayment()">
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Down Payment (%)</label>
                        <input type="number" id="downPaymentPercent" value="25" min="25" max="100" oninput="validateDownPayment()">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="downPaymentRemark">
                            üí∞ Min: 25% for resale condo (5% cash + 20% cash/CPF)
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Loan Tenure (Years)</label>
                        <input type="number" id="loanTenure" value="25" min="1" max="30" oninput="validateTenure()">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="tenureRemark">
                            ‚è±Ô∏è Max: 30 years or up to age 65 (whichever is shorter)
                        </small>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" id="interestRate" value="2.6" step="0.1" min="0">
                        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;" id="interestRateRemark">
                            üìä Current market rate for bank loans
                        </small>
                    </div>
                    <div class="input-group">
                        <label>Loan Type</label>
                        <select id="loanType" onchange="updateLoanType()">
                            <option value="bank_fixed">Bank Loan - Fixed Rate</option>
                            <option value="bank_floating">Bank Loan - Floating Rate</option>
                            <option value="hdb" disabled>HDB Loan (HDB properties only)</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="calculate()">Calculate Payment Plan</button>

                <div class="info-badge" id="cashCpfInfo">
                    üí° 5% must be paid in cash, remaining down payment can use CPF
                </div>
            </div>

            <!-- Summary Card -->
            <div class="card full-width">
                <h2>Financial Summary</h2>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Down Payment</label>
                        <div class="value" id="downPaymentAmount">S$325,000</div>
                    </div>
                    <div class="summary-item">
                        <label>Loan Amount</label>
                        <div class="value" id="loanAmount">S$975,000</div>
                    </div>
                    <div class="summary-item">
                        <label>Monthly Payment</label>
                        <div class="value" id="monthlyPayment">S$4,350</div>
                    </div>
                    <div class="summary-item">
                        <label>Total Interest</label>
                        <div class="value" id="totalInterest">S$330,000</div>
                    </div>
                    <div class="summary-item">
                        <label>Buyer's Stamp Duty (BSD)</label>
                        <div class="value" id="stampDuty">S$43,600</div>
                    </div>
                    <div class="summary-item">
                        <label>Additional BSD (ABSD)</label>
                        <div class="value" id="absdAmount">S$0</div>
                    </div>
                    <div class="summary-item">
                        <label>Total Stamp Duty</label>
                        <div class="value" id="totalStampDuty">S$43,600</div>
                    </div>
                    <div class="summary-item">
                        <label>Total Cash Needed</label>
                        <div class="value" id="cashNeeded">S$268,600</div>
                    </div>
                    <div class="summary-item">
                        <label>TDSR Ratio</label>
                        <div class="value" id="tdsrRatio">29%</div>
                    </div>
                    <div class="summary-item">
                        <label>Cash After CPF</label>
                        <div class="value" id="cashPayment">S$0</div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>Down Payment Progress</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 30%;">30%</div>
                    </div>
                </div>

                <div class="info-badge">
                    üìä TDSR limit: 55% of gross monthly income
                </div>
            </div>

            <!-- Payment Breakdown Chart -->
            <div class="card full-width">
                <h2>Payment Breakdown Over Time</h2>
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>

            <!-- Payment Schedule -->
            <div class="card full-width">
                <h2>Monthly Payment Schedule</h2>
                <div class="payment-schedule">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Payment</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                        </tbody>
                    </table>
                </div>
                <div class="schedule-controls">
                    <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                    <div class="display-selector">
                        <label>Show:</label>
                        <select id="scheduleDisplay" onchange="calculate()">
                            <option value="12">12 months</option>
                            <option value="60">5 years</option>
                            <option value="120">10 years</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let paymentChart;

        function formatCurrency(amount) {
            return 'S$' + amount.toLocaleString('en-SG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return 'S$' + (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return 'S$' + (amount / 1000).toFixed(0) + 'K';
            }
            return 'S$' + amount.toLocaleString('en-SG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatNumberInput(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/[^\d]/g, '');
            
            // Convert to number and back to formatted string
            if (value) {
                let number = parseInt(value);
                input.value = number.toLocaleString('en-SG');
            }
        }

        function getNumericValue(input) {
            // Remove commas and convert to number
            return parseFloat(input.value.replace(/,/g, '')) || 0;
        }

        function updateSubtitle() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const subtitle = document.getElementById('subtitle');
            subtitle.textContent = `Plan and track your ${formatCurrencyShort(propertyPrice)} property investment`;
        }

        function calculateStampDuty(price) {
            let duty = 0;
            if (price <= 180000) {
                duty = price * 0.01;
            } else if (price <= 360000) {
                duty = 1800 + (price - 180000) * 0.02;
            } else if (price <= 1000000) {
                duty = 1800 + 3600 + (price - 360000) * 0.03;
            } else {
                duty = 1800 + 3600 + 19200 + (price - 1000000) * 0.04;
            }
            return duty;
        }

        function calculateABSD(price, buyerProfile, entityType = null, propertyType = 'condo') {
            // HDB properties: No ABSD for Singapore Citizens and PRs
            if (propertyType === 'hdb') {
                if (buyerProfile === 'sc_first' || buyerProfile === 'sc_second' || buyerProfile === 'sc_third' ||
                    buyerProfile === 'pr_first' || buyerProfile === 'pr_second') {
                    return 0; // No ABSD for citizens and PRs buying HDB
                }
            }
            
            const rates = {
                'sc_first': 0,
                'sc_second': 0.20,
                'sc_third': 0.30,
                'pr_first': 0.05,
                'pr_second': 0.30,
                'foreigner': 0.60,
                'entity': entityType === 'housing_developer' ? 0.35 : 0.65
            };
            
            const rate = rates[buyerProfile] || 0;
            return price * rate;
        }

        function getABSDRate(buyerProfile, entityType = null, propertyType = 'condo') {
            // HDB properties: No ABSD for Singapore Citizens and PRs
            if (propertyType === 'hdb') {
                if (buyerProfile === 'sc_first' || buyerProfile === 'sc_second' || buyerProfile === 'sc_third' ||
                    buyerProfile === 'pr_first' || buyerProfile === 'pr_second') {
                    return 0;
                }
            }
            
            const rates = {
                'sc_first': 0,
                'sc_second': 20,
                'sc_third': 30,
                'pr_first': 5,
                'pr_second': 30,
                'foreigner': 60,
                'entity': entityType === 'housing_developer' ? 35 : 65
            };
            
            return rates[buyerProfile] || 0;
        }

        function updateABSD() {
            const buyerProfile = document.getElementById('buyerProfile').value;
            const entityTypeGroup = document.getElementById('entityTypeGroup');
            const absdInfo = document.getElementById('absdInfo');
            const propertyType = document.getElementById('propertyType').value;
            
            // Show/hide entity type selection
            if (buyerProfile === 'entity') {
                entityTypeGroup.style.display = 'block';
            } else {
                entityTypeGroup.style.display = 'none';
            }
            
            // Update ABSD info badge
            const entityType = document.getElementById('entityType').value;
            const rate = getABSDRate(buyerProfile, entityType, propertyType);
            
            if (rate === 0) {
                absdInfo.style.background = '#d4edda';
                if (propertyType === 'hdb' && (buyerProfile.startsWith('sc_') || buyerProfile.startsWith('pr_'))) {
                    absdInfo.innerHTML = 'üèõÔ∏è ABSD: 0% (No ABSD for citizens/PRs buying HDB)';
                } else {
                    absdInfo.innerHTML = 'üèõÔ∏è ABSD: 0% (No additional stamp duty)';
                }
            } else {
                absdInfo.style.background = '#ffd7d7';
                absdInfo.innerHTML = `üèõÔ∏è ABSD: ${rate}% applies to your purchase`;
            }
            
            // Recalculate if needed
            calculate();
        }

        function updateMaxTenure() {
            const age = parseInt(document.getElementById('age').value) || 35;
            const maxAge = 65;
            const maxTenureByAge = Math.max(1, maxAge - age);
            const absoluteMaxTenure = 30;
            const maxTenure = Math.min(maxTenureByAge, absoluteMaxTenure);
            
            const tenureInput = document.getElementById('loanTenure');
            const tenureRemark = document.getElementById('tenureRemark');
            
            // Update max attribute
            tenureInput.max = maxTenure;
            
            // Update the current value if it exceeds the max
            if (parseInt(tenureInput.value) > maxTenure) {
                tenureInput.value = maxTenure;
            }
            
            // Update remark
            if (maxTenureByAge <= absoluteMaxTenure) {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (based on age ${age}, loan must end by 65)`;
                tenureRemark.style.color = '#d9534f';
            } else {
                tenureRemark.innerHTML = `‚è±Ô∏è Max: ${maxTenure} years (standard maximum)`;
                tenureRemark.style.color = '#666';
            }
        }

        function validateTenure() {
            const tenureInput = document.getElementById('loanTenure');
            const maxTenure = parseInt(tenureInput.max);
            const currentValue = parseInt(tenureInput.value);
            
            if (currentValue > maxTenure) {
                tenureInput.value = maxTenure;
            }
            
            if (currentValue < 1) {
                tenureInput.value = 1;
            }
        }

        function validateDownPayment() {
            const downPaymentInput = document.getElementById('downPaymentPercent');
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentRemark = document.getElementById('downPaymentRemark');
            const downPaymentPercent = parseFloat(downPaymentInput.value);
            const propertyType = document.getElementById('propertyType').value;
            
            // Determine minimum down payment based on property type and loan amount
            const loanAmount = propertyPrice * (1 - downPaymentPercent / 100);
            let minDownPayment = 25; // Default 25% for resale condo
            
            if (propertyType === 'hdb') {
                // HDB rules
                minDownPayment = 20; // HDB minimum is 20%
            } else {
                // Condo rules
                // For bank loans on private property:
                // - First $1M: max 75% LTV (25% down payment)
                // - Above $1M: max 45% LTV (55% down payment) for the excess
                
                if (loanAmount > 1000000) {
                    // Calculate required down payment for loans above $1M
                    const excessAmount = propertyPrice - 1000000;
                    const minDownPaymentAmount = (propertyPrice * 0.25) + (excessAmount * 0.30);
                    minDownPayment = Math.ceil((minDownPaymentAmount / propertyPrice) * 100);
                }
            }
            
            // Update min attribute
            downPaymentInput.min = minDownPayment;
            
            // Show warnings but allow user to edit
            if (downPaymentPercent < minDownPayment) {
                downPaymentRemark.innerHTML = `‚ö†Ô∏è Warning: Minimum ${minDownPayment}% required to meet LTV limits`;
                downPaymentRemark.style.color = '#d9534f';
                downPaymentInput.style.borderColor = '#d9534f';
            } else if (downPaymentPercent > 100) {
                downPaymentRemark.innerHTML = `‚ö†Ô∏è Warning: Cannot exceed 100% (full cash purchase)`;
                downPaymentRemark.style.color = '#d9534f';
                downPaymentInput.style.borderColor = '#d9534f';
            } else {
                // Show appropriate message based on property type
                if (propertyType === 'hdb') {
                    downPaymentRemark.innerHTML = `üí∞ Min: 20% for HDB resale (max 80% LTV)`;
                } else if (propertyPrice > 1000000) {
                    downPaymentRemark.innerHTML = `üí∞ Min: ${minDownPayment}% for properties above S$1M (LTV restrictions apply)`;
                } else {
                    downPaymentRemark.innerHTML = `üí∞ Min: 25% for resale condo (max 75% LTV)`;
                }
                downPaymentRemark.style.color = '#666';
                downPaymentInput.style.borderColor = '#e0e0e0';
            }
        }

        function updatePropertyType() {
            const propertyType = document.getElementById('propertyType').value;
            const loanTypeSelect = document.getElementById('loanType');
            const buyerProfileSelect = document.getElementById('buyerProfile');
            const interestRateInput = document.getElementById('interestRate');
            const interestRateRemark = document.getElementById('interestRateRemark');
            const propertyPriceInput = document.getElementById('propertyPrice');
            
            if (propertyType === 'hdb') {
                // Enable HDB loan option
                loanTypeSelect.querySelector('option[value="hdb"]').disabled = false;
                loanTypeSelect.value = 'hdb';
                
                // Set HDB loan rate
                interestRateInput.value = '2.6';
                interestRateRemark.innerHTML = 'üè¶ HDB loan rate: CPF OA rate + 0.1%';
                interestRateRemark.style.color = '#5cb85c';
                
                // Update default price for HDB
                if (getNumericValue(propertyPriceInput) > 1000000) {
                    propertyPriceInput.value = '500,000';
                    formatNumberInput(propertyPriceInput);
                }
                
                // Disable entity options for HDB
                buyerProfileSelect.querySelector('option[value="entity"]').disabled = true;
                if (buyerProfileSelect.value === 'entity') {
                    buyerProfileSelect.value = 'sc_first';
                }
                
            } else {
                // Disable HDB loan option for condo
                loanTypeSelect.querySelector('option[value="hdb"]').disabled = true;
                if (loanTypeSelect.value === 'hdb') {
                    loanTypeSelect.value = 'bank_floating';
                }
                
                interestRateInput.value = '2.6';
                interestRateRemark.innerHTML = 'üìä Current market rate for bank loans';
                interestRateRemark.style.color = '#666';
                
                // Update default price for condo
                if (getNumericValue(propertyPriceInput) < 800000) {
                    propertyPriceInput.value = '1,300,000';
                    formatNumberInput(propertyPriceInput);
                }
                
                // Enable entity options for condo
                buyerProfileSelect.querySelector('option[value="entity"]').disabled = false;
            }
            
            updateLoanType();
            validateDownPayment();
            updateSubtitle();
            updateABSD();
        }

        function updateLoanType() {
            const loanType = document.getElementById('loanType').value;
            const interestRateInput = document.getElementById('interestRate');
            const interestRateRemark = document.getElementById('interestRateRemark');
            
            if (loanType === 'hdb') {
                // HDB loan rate (CPF OA + 0.1%)
                interestRateInput.value = '2.6';
                interestRateInput.disabled = true;
                interestRateRemark.innerHTML = 'üè¶ HDB loan rate: CPF OA rate (2.5%) + 0.1% = 2.6%';
                interestRateRemark.style.color = '#5cb85c';
            } else {
                interestRateInput.disabled = false;
                if (loanType === 'bank_fixed') {
                    interestRateInput.value = '2.6';
                    interestRateRemark.innerHTML = 'üìä Typical fixed rate: 2.4% - 2.8%';
                } else {
                    interestRateInput.value = '2.6';
                    interestRateRemark.innerHTML = 'üìä Typical floating rate (SORA): 2.5% - 3.0%';
                }
                interestRateRemark.style.color = '#666';
            }
        }

        function calculate() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value);
            const loanTenure = parseFloat(document.getElementById('loanTenure').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const monthlyIncome = getNumericValue(document.getElementById('monthlyIncome'));
            const cpfAvailable = getNumericValue(document.getElementById('cpfAvailable'));
            const monthlyCPF = getNumericValue(document.getElementById('monthlyCPF'));
            const buyerProfile = document.getElementById('buyerProfile').value;
            const entityType = document.getElementById('entityType').value;
            const propertyType = document.getElementById('propertyType').value;

            // Update subtitle
            updateSubtitle();

            // Calculate basic values
            const downPayment = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPayment;
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTenure * 12;

            // Calculate monthly payment using mortgage formula
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / 
                                   (Math.pow(1 + monthlyRate, totalPayments) - 1);

            const totalPaid = monthlyPayment * totalPayments;
            const totalInterest = totalPaid - loanAmount;

            // Calculate stamp duties
            const stampDuty = calculateStampDuty(propertyPrice);
            const absdAmount = calculateABSD(propertyPrice, buyerProfile, entityType, propertyType);
            const totalStampDuty = stampDuty + absdAmount;

            // Calculate upfront costs
            const minCashDownPayment = propertyPrice * 0.05; // 5% must be cash
            const cpfUsedForDownPayment = Math.min(cpfAvailable, downPayment - minCashDownPayment);
            const cashForDownPayment = downPayment - cpfUsedForDownPayment;
            const totalCashNeeded = cashForDownPayment + totalStampDuty; // ABSD + BSD must be paid in cash

            // Calculate TDSR
            const tdsrRatio = (monthlyPayment / monthlyIncome) * 100;

            // Update cash/CPF info based on property type
            const cashCpfInfo = document.getElementById('cashCpfInfo');
            if (propertyType === 'hdb') {
                cashCpfInfo.innerHTML = 'üí° HDB: Min 5% cash down payment, can use CPF for remaining';
            } else {
                cashCpfInfo.innerHTML = 'üí° Condo: Min 5% cash, remaining down payment can use CPF';
            }

            // Update summary
            document.getElementById('downPaymentAmount').textContent = formatCurrency(downPayment);
            document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
            document.getElementById('stampDuty').textContent = formatCurrency(stampDuty);
            document.getElementById('absdAmount').textContent = formatCurrency(absdAmount);
            document.getElementById('totalStampDuty').textContent = formatCurrency(totalStampDuty);
            document.getElementById('cashNeeded').textContent = formatCurrency(totalCashNeeded);
            document.getElementById('tdsrRatio').textContent = tdsrRatio.toFixed(1) + '%';
            document.getElementById('cashPayment').textContent = formatCurrency(cashForDownPayment);

            // Update progress bar
            const savedAmount = cpfAvailable; // This could be connected to another input
            const progressPercent = Math.min((savedAmount / downPayment) * 100, 100);
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressBar').textContent = progressPercent.toFixed(0) + '%';

            // Generate payment schedule
            generatePaymentSchedule(loanAmount, monthlyRate, monthlyPayment, totalPayments);

            // Update chart
            updateChart(loanAmount, totalInterest, totalPayments, monthlyRate, monthlyPayment);
        }

        function generatePaymentSchedule(loanAmount, monthlyRate, monthlyPayment, totalPayments) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            let balance = loanAmount;
            const displayOption = document.getElementById('scheduleDisplay').value;
            const monthsToShow = displayOption === 'all' ? totalPayments : Math.min(parseInt(displayOption), totalPayments);

            for (let i = 1; i <= monthsToShow; i++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                const row = tbody.insertRow();
                row.insertCell(0).textContent = i;
                row.insertCell(1).textContent = formatCurrency(monthlyPayment);
                row.insertCell(2).textContent = formatCurrency(principalPayment);
                row.insertCell(3).textContent = formatCurrency(interestPayment);
                row.insertCell(4).textContent = formatCurrency(balance);
            }
        }

        function exportToCSV() {
            const propertyPrice = getNumericValue(document.getElementById('propertyPrice'));
            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value);
            const loanTenure = parseFloat(document.getElementById('loanTenure').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;

            const downPayment = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPayment;
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTenure * 12;
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / 
                                   (Math.pow(1 + monthlyRate, totalPayments) - 1);

            // Generate full schedule for CSV
            let csvContent = "Month,Payment,Principal,Interest,Balance\n";
            let balance = loanAmount;

            for (let i = 1; i <= totalPayments; i++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                balance -= principalPayment;

                csvContent += `${i},${monthlyPayment.toFixed(2)},${principalPayment.toFixed(2)},${interestPayment.toFixed(2)},${balance.toFixed(2)}\n`;
            }

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'condo_payment_schedule.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateChart(loanAmount, totalInterest, totalPayments, monthlyRate, monthlyPayment) {
            const years = Math.ceil(totalPayments / 12);
            const labels = [];
            const principalData = [];
            const interestData = [];
            let balance = loanAmount;
            let totalPrincipalPaid = 0;
            let totalInterestPaid = 0;

            for (let year = 0; year <= years; year++) {
                labels.push('Year ' + year);
                principalData.push(totalPrincipalPaid);
                interestData.push(totalInterestPaid);

                // Calculate payments for the next year
                const paymentsThisYear = Math.min(12, totalPayments - (year * 12));
                for (let month = 0; month < paymentsThisYear; month++) {
                    const interestPayment = balance * monthlyRate;
                    const principalPayment = monthlyPayment - interestPayment;
                    balance -= principalPayment;
                    totalPrincipalPaid += principalPayment;
                    totalInterestPaid += interestPayment;
                }
            }

            if (paymentChart) {
                paymentChart.destroy();
            }

            const ctx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Principal Paid',
                        data: principalData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Interest Paid',
                        data: interestData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S$' + (value/1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate on page load
        calculate();
        updateMaxTenure();
        validateDownPayment();
    </script>
</body>
</html>
